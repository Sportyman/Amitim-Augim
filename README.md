
# Amitim Activity Finder - תיעוד טכני ומדריך למפתח

ברוכים הבאים לקובץ התיעוד של אפליקציית "עמיתים - מצא את החוג שלך".
מסמך זה נועד לספק למתכנתים עתידיים את כל המידע הנדרש כדי להבין, לתחזק ולהרחיב את המערכת.

---

## 🛠 טכנולוגיות וסביבת עבודה (Tech Stack)

הפרויקט בנוי על בסיס טכנולוגיות Web מודרניות:

*   **Frontend Framework:** React 18 (עם TypeScript).
*   **Build Tool:** Vite.
*   **Styling:** Tailwind CSS (עיצוב רספונסיבי מלא, תמיכה ב-RTL).
*   **Routing:** React Router DOM (Single Page Application).
*   **Backend / Database:** Google Firebase (Firestore + Authentication).
*   **AI Integration:** Google Gemini API (`@google/genai`) - משמש לניתוח טקסט, יצירת תיאורים, ותיקון נתונים.
*   **Icons:** Lucide React + רכיבי SVG מותאמים אישית.

---

## 🚀 התקנה והרצה מקומית

1.  **שכפול הפרויקט:**
    ```bash
    git clone [repository-url]
    cd amitim-activity-finder
    ```

2.  **התקנת חבילות:**
    ```bash
    npm install
    ```

3.  **הגדרת משתני סביבה (.env):**
    יש ליצור קובץ `.env` בשורש הפרויקט עם המפתחות הבאים:
    ```env
    VITE_API_KEY=YOUR_GEMINI_API_KEY
    # אופציונלי - מגדיר את המייל של מנהל העל הראשוני
    VITE_ADMIN_EMAIL=your-email@gmail.com 
    ```
    *הערה: הגדרות ה-Firebase (API Key, Project ID) נמצאות כרגע בקובץ `services/firebase.ts`. בסביבת ייצור מומלץ להעבירן גם ל-.env.*

4.  **הרצת שרת פיתוח:**
    ```bash
    npm run dev
    ```

---

## 🗄️ מבנה הנתונים (Firestore Schema)

מסד הנתונים בנוי על NoSQL (Firestore) וכולל את האוספים (Collections) הבאים:

### 1. `activities` (החוגים)
האוסף המרכזי המכיל את כל המידע המוצג באפליקציה.
*   `id`: מזהה ייחודי (בדרך כלל מתוך ה-CSV, או ג'נרי לחוגים חדשים).
*   `title`: שם החוג.
*   `category`: קטגוריה (טקסט חופשי, מסונכרן מול אוסף הקטגוריות).
*   `location`: כתובת מלאה.
*   `city`: שם העיר (לסינונים).
*   `price`: מחיר (מספר).
*   `ageGroup`: מחרוזת טקסט (למשל: "נוער 13-18").
*   `minAge`, `maxAge`: מספרים (לסינון חכם).
*   `schedule`: טקסט חופשי של זמנים.
*   `imageUrl`: קישור לתמונה.
*   `isVisible`: בוליאני (האם להציג באפליקציה).
*   `views`: מונה צפיות (לסטטיסטיקה ומיון).

### 2. `activity_images` (מטמון תמונות)
אוסף עזר קריטי. מטרתו לשמור את הקישור לתמונות שהוגדרו ידנית ע"י המנהל, כך שבטעינת קובץ CSV חדש (שבו אין תמונות או שיש תמונות שגויות), המערכת תדע לשחזר את התמונה הנכונה לפי ה-ID של החוג.
*   `Doc ID`: זהה ל-`id` של החוג.
*   `imageUrl`: ה-URL שנשמר.

### 3. `categories` (ניהול קטגוריות)
מאפשר למנהל להוסיף/להסיר קטגוריות ולקבוע סדר ואייקונים.
*   `name`: שם הקטגוריה.
*   `iconId`: מזהה לאייקון (מתוך `constants.ts`) או אימוג'י.
*   `order`: מספר סידורי לתצוגה.
*   `isVisible`: האם להציג במסננים.

### 4. `audit_logs` (היסטוריה וגיבוי)
תיעוד כל פעולה שנעשתה במערכת הניהול (יצירה, עריכה, מחיקה, ייבוא). מאפשר "שחזור לאחור" (Rollback).

### 5. `users` (הרשאות)
ניהול תפקידים.
*   `Doc ID`: אימייל המשתמש.
*   `role`: רמת הרשאה (`super_admin`, `admin`, `editor`).

### 6. `settings` (הגדרות גלובליות)
מסמך יחיד `app_config` השומר הגדרות כמו "עיצוב צבעוני לקטגוריות".

---

## 🧠 מנגנונים מרכזיים ומידע למפתח

### 1. מנגנון ייבוא CSV חכם (`Smart Sync`)
נמצא ב-`components/admin/DatabaseManagement.tsx`.
*   **הבעיה:** קבצי CSV מגיעים עם עמודות משתנות ושמות שונים (למשל `price` לעומת `מחיר`).
*   **הפתרון:** הפונקציה `parseCSV` משתמשת במיפוי דינמי (Fuzzy Matching) לזיהוי עמודות.
*   **לוגיקת העדכון:** המערכת לא מוחקת את כל הדאטה! היא בודקת לפי `ID`:
    *   אם החוג קיים: מעדכנת רק את הפרטים היבשים (מחיר, שעה), אך שומרת על תמונות והגדרות נראות.
    *   אם החוג חדש: יוצרת אותו.
    *   אם החוג נעלם מהקובץ: יש אופציה להפוך אותו ל"לא פעיל" במקום למחוק (Soft Delete).

### 2. ניהול תמונות (`Image Persistence`)
כדי למנוע מצב שבו טעינת CSV דורסת תמונות שהמנהל העלה ידנית, כל תמונה שנשמרת דרך הממשק נכתבת גם לאוסף `activity_images`.
בעת ייבוא CSV, המערכת בודקת קודם כל אם קיימת תמונה ב-Cache עבור ה-ID הזה. אם כן - היא משתמשת בה במקום במה שכתוב (או חסר) ב-CSV.

### 3. חיפוש וסינון (`PublicHome.tsx`)
*   החיפוש הוא משולב: טקסט חופשי + קטגוריות + טווח גילאים + עיר/מיקום.
*   **Gemini AI:** בחיפוש טקסט חופשי, אנו שולחים את הטקסט ל-Gemini כדי לקבל "מילות מפתח נרדפות" (למשל: חיפוש "בריכה" יחזיר גם תוצאות של "שחייה", "מים").
*   **חיפוש מעורפל (Fuzzy):** סינון קטגוריות מתבצע באמצעות `includes` ולא התאמה מדויקת, כדי למנוע פספוסים (למשל "ספורט" יתפוס גם "ספורט אתגרי").

### 4. אופטימיזציית נתונים (`AIEnrichmentTool.tsx`)
כלי אדמין שרץ על כל החוגים ושולח אותם ל-Gemini כדי:
1.  לחלץ גילאי מינימום/מקסימום מתוך טקסט (למשל "גיל הזהב" -> 60-120).
2.  לתקן שגיאות כתיב.
3.  ליצור תגיות חיפוש.

---

## 🔐 הרשאות (Permissions)

מנוהל ב-`utils/permissions.ts` וב-`contexts/AuthContext.tsx`.
*   **Super Admin:** גישה להכל, כולל ניהול משתמשים ומחיקה גורפת. מוגדר ע"י משתנה סביבה או מסד הנתונים.
*   **Admin:** יצירה, עריכה, מחיקת חוגים, ייבוא דאטה.
*   **Editor:** עריכת פרטים בלבד (ללא מחיקה).

---

## 📂 מבנה התיקיות

*   `/components`: רכיבי UI (כרטיסיות, פילטרים, טפסים).
    *   `/admin`: רכיבים ייעודיים לדף הניהול (ייבוא, משתמשים, עריכה קבוצתית).
*   `/pages`: עמודים ראשיים (`PublicHome`, `AdminDashboard`, `LoginPage`).
*   `/services`:
    *   `firebase.ts`: אתחול.
    *   `dbService.ts`: כל הקריאות לדאטה-בייס (מופרד מהלוגיקה של הקומפוננטות).
    *   `geminiService.ts`: אינטגרציה עם ה-AI.
*   `/utils`: פונקציות עזר (פרמוט תאריכים, הרשאות).
*   `/contexts`: ניהול State גלובלי (AuthContext).

---

## 📝 הערות לשינויים עתידיים

*   **שינוי CSV:** אם מבנה ה-CSV משתנה דרמטית, יש לעדכן את המיפוי ב-`DatabaseManagement.tsx`.
*   **הוספת אייקונים:** יש להוסיף לקובץ `icons.tsx` ולמפות ב-`constants.ts`.
*   **גיבוי:** מומלץ לבצע ייצוא (Export) של הנתונים לפני ביצוע שינויים גורפים (יש כפתור גיבוי בדשבורד).

בהצלחה!
